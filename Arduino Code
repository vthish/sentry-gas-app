#include <ESP8266WiFi.h>      
#include <ESP8266WebServer.h> 
#include <Firebase_ESP_Client.h>
#include <addons/TokenHelper.h> 

// --- PIN CONFIGURATION ---
#define VALVE_PIN   D7   // Relay Module
#define BUZZER_PIN  D1   // Buzzer Module
#define GAS_SENSOR  A0   // MQ-2 Gas Sensor
#define ONBOARD_LED D4   // WiFi Status LED

// --- LOGIC SETTINGS ---

// 1. Relay Logic (Active LOW)
// If your relay works opposite to this, swap LOW and HIGH.
#define RELAY_OPEN    LOW    // Signal to Open Valve (ON)
#define RELAY_CLOSE   HIGH   // Signal to Close Valve (OFF)

// 2. Buzzer Logic (Fixed for Active LOW modules)
// If the buzzer sounds when it should be silent, swap these values.
#define BUZZER_ON     LOW    // Turn Buzzer ON
#define BUZZER_OFF    HIGH   // Turn Buzzer OFF

// Gas Threshold (Sensitivity)
#define GAS_THRESHOLD 400 

// --- FIREBASE CONFIGURATION ---
#define API_KEY             "AIzaSyAbohekiAbD-vJUcAXtHkuoOeihDKbSmBs"
#define FIREBASE_PROJECT_ID "my-sentry-gas-final"
#define USER_EMAIL          "hub@sentry.com"
#define USER_PASSWORD       "123456"
#define FIREBASE_DOC_PATH   "hubs/SENTRY_HUB_V1" 

ESP8266WebServer server(80);
FirebaseData fbdo;      
FirebaseAuth auth;
FirebaseConfig config;

String wifiSSID = "";
String wifiPassword = "";
bool tryToConnect = false;
bool isConnected = false;
bool isGasLeak = false; 

// --- WIFI CONFIGURATION HANDLER ---
void handleConfig() {
  server.send(200, "text/plain", "connected");
  if (server.hasArg("ssid") && server.hasArg("password")) {
    wifiSSID = server.arg("ssid");
    wifiPassword = server.arg("password");
    tryToConnect = true; // Trigger connection attempt in loop
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);

  // Initialize Pins
  pinMode(VALVE_PIN, OUTPUT);
  digitalWrite(VALVE_PIN, RELAY_CLOSE); // Close valve on startup for safety
  
  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(BUZZER_PIN, BUZZER_OFF); // Ensure Buzzer is OFF initially
  
  pinMode(ONBOARD_LED, OUTPUT);
  pinMode(GAS_SENSOR, INPUT);

  // Setup WiFi in AP+Station Mode
  WiFi.mode(WIFI_AP_STA); 
  WiFi.softAP("Sentry-Hub_V1"); // Create Open Hotspot

  Serial.println("[SYSTEM] Ready. Connect to 'Sentry-Hub_V1'.");
  
  server.on("/config", HTTP_POST, handleConfig); 
  server.begin();
}

void loop() {
  server.handleClient();

  // --- CONNECT LOGIC ---
  if (tryToConnect) {
      Serial.print("Connecting to: "); Serial.println(wifiSSID);
      WiFi.begin(wifiSSID.c_str(), wifiPassword.c_str());
      
      unsigned long start = millis();
      // Wait 15 seconds for connection
      while (WiFi.status() != WL_CONNECTED && millis() - start < 15000) { 
        digitalWrite(ONBOARD_LED, !digitalRead(ONBOARD_LED)); // Blink LED
        delay(500); 
      }
      
      if (WiFi.status() == WL_CONNECTED) {
        Serial.println("WiFi Connected!");
        digitalWrite(ONBOARD_LED, LOW); // LED ON (Connected)
        
        // Initialize Firebase
        config.api_key = API_KEY;
        auth.user.email = USER_EMAIL;
        auth.user.password = USER_PASSWORD;
        config.token_status_callback = tokenStatusCallback; 
        Firebase.begin(&config, &auth);
        Firebase.reconnectWiFi(true);
        
        isConnected = true;
        tryToConnect = false; // Stop trying to connect
      } else {
        tryToConnect = false; // Stop trying if failed
      }
  }

  // --- MAIN SENSOR LOOP ---
  // Runs every 1 second to debounce sensor
  static unsigned long lastCheck = 0;
  if (millis() - lastCheck > 1000) {
      lastCheck = millis();
      
      int gasValue = analogRead(GAS_SENSOR);
      Serial.print("[STATUS] Gas: "); 
      Serial.println(gasValue);

      if (gasValue > GAS_THRESHOLD) {
          // === LEAK DETECTED ===
          Serial.println(" -> LEAK! (Safety OFF)");
          
          digitalWrite(VALVE_PIN, RELAY_CLOSE);  // Close Valve
          digitalWrite(BUZZER_PIN, BUZZER_ON);   // Turn ON Buzzer
          
          // Send Alert to Firebase (Only once per leak event)
          if (!isGasLeak) {
             isGasLeak = true;
             if (isConnected && Firebase.ready()) {
                FirebaseJson update;
                update.set("fields/valveOn/booleanValue", false);
                update.set("fields/gasLeak/booleanValue", true);
                
                // Debug field to monitor sensor value
                update.set("fields/mq2_debug/integerValue", gasValue); 
                
                Firebase.Firestore.patchDocument(&fbdo, FIREBASE_PROJECT_ID, "", FIREBASE_DOC_PATH, update.raw(), "valveOn,gasLeak,mq2_debug");
             }
          }
      } else {
          // === SAFE CONDITION ===
          digitalWrite(BUZZER_PIN, BUZZER_OFF); // Turn OFF Buzzer
          
          // Reset Leak Status
          if (isGasLeak) {
             isGasLeak = false;
             Serial.println(" -> Safe Now.");
             if (isConnected && Firebase.ready()) {
                FirebaseJson update;
                update.set("fields/gasLeak/booleanValue", false);
                Firebase.Firestore.patchDocument(&fbdo, FIREBASE_PROJECT_ID, "", FIREBASE_DOC_PATH, update.raw(), "gasLeak");
             }
          }

          // === APP CONTROL CHECK ===
          // Listen for valve commands from the App
          if (isConnected && Firebase.ready()) {
             if (Firebase.Firestore.getDocument(&fbdo, FIREBASE_PROJECT_ID, "", FIREBASE_DOC_PATH, "")) {
                String payload = fbdo.payload();
                
                // Smart String Search for 'valveOn'
                int keyIndex = payload.indexOf("valveOn");
                if (keyIndex > -1) {
                    String sub = payload.substring(keyIndex, keyIndex + 60);
                    if (sub.indexOf("true") > -1) {
                        Serial.println(" -> App: OPEN VALVE");
                        digitalWrite(VALVE_PIN, RELAY_OPEN); 
                    } else if (sub.indexOf("false") > -1) {
                        Serial.println(" -> App: CLOSE VALVE");
                        digitalWrite(VALVE_PIN, RELAY_CLOSE); 
                    }
                }
             }
          }
      }
  }
}
