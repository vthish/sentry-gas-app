const require_rolldown_runtime = require('../../../_virtual/rolldown_runtime.js');
const require_common_onInit = require('../../../common/onInit.js');
const require_v2_trace = require('../../trace.js');
const require_v2_providers_alerts_alerts = require('./alerts.js');


var performance_exports =  require_rolldown_runtime.__export({
	convertPayload: () => convertPayload,
	getOptsAndApp: () => getOptsAndApp,
	onThresholdAlertPublished: () => onThresholdAlertPublished,
	thresholdAlert: () => thresholdAlert
});

const thresholdAlert = "performance.threshold";

function onThresholdAlertPublished(appIdOrOptsOrHandler, handler) {
	if (typeof appIdOrOptsOrHandler === "function") {
		handler = appIdOrOptsOrHandler;
		appIdOrOptsOrHandler = {};
	}
	const [opts, appId] = getOptsAndApp(appIdOrOptsOrHandler);
	const func = (raw) => {
		const event = require_v2_providers_alerts_alerts.convertAlertAndApp(raw);
		const convertedPayload = convertPayload(event.data.payload);
		event.data.payload = convertedPayload;
		return require_v2_trace.wrapTraceContext(require_common_onInit.withInit(handler(event)));
	};
	func.run = handler;
	func.__endpoint = require_v2_providers_alerts_alerts.getEndpointAnnotation(opts, thresholdAlert, appId);
	return func;
}

function getOptsAndApp(appIdOrOpts) {
	if (typeof appIdOrOpts === "string") {
		return [{}, appIdOrOpts];
	}
	const opts = { ...appIdOrOpts };
	const appId = appIdOrOpts.appId;
	delete opts.appId;
	return [opts, appId];
}

function convertPayload(raw) {
	const payload = { ...raw };
	if (typeof payload.conditionPercentile !== "undefined" && payload.conditionPercentile === 0) {
		delete payload.conditionPercentile;
	}
	if (typeof payload.appVersion !== "undefined" && payload.appVersion.length === 0) {
		delete payload.appVersion;
	}
	return payload;
}


exports.convertPayload = convertPayload;
exports.getOptsAndApp = getOptsAndApp;
exports.onThresholdAlertPublished = onThresholdAlertPublished;
Object.defineProperty(exports, 'performance_exports', {
  enumerable: true,
  get: function () {
    return performance_exports;
  }
});
exports.thresholdAlert = thresholdAlert;
