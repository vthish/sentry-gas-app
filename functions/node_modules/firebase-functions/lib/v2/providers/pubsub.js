const require_rolldown_runtime = require('../../_virtual/rolldown_runtime.js');
const require_runtime_manifest = require('../../runtime/manifest.js');
const require_common_encoding = require('../../common/encoding.js');
const require_common_onInit = require('../../common/onInit.js');
const require_v2_trace = require('../trace.js');
const require_v2_options = require('../options.js');


var pubsub_exports =  require_rolldown_runtime.__export({
	Message: () => Message,
	onMessagePublished: () => onMessagePublished
});


var Message = class {
	
	constructor(data) {
		this.messageId = data.messageId;
		this.data = data.data;
		this.attributes = data.attributes || {};
		this.orderingKey = data.orderingKey || "";
		this.publishTime = data.publishTime || new Date().toISOString();
		this._json = data.json;
	}
	
	get json() {
		if (typeof this._json === "undefined") {
			try {
				this._json = JSON.parse(Buffer.from(this.data, "base64").toString("utf8"));
			} catch (err) {
				throw new Error(`Unable to parse Pub/Sub message data as JSON: ${err.message}`);
			}
		}
		return this._json;
	}
	
	toJSON() {
		const json = {
			messageId: this.messageId,
			data: this.data,
			publishTime: this.publishTime
		};
		if (Object.keys(this.attributes).length) {
			json.attributes = this.attributes;
		}
		if (this.orderingKey) {
			json.orderingKey = this.orderingKey;
		}
		return json;
	}
};

function onMessagePublished(topicOrOptions, handler) {
	let topic;
	let opts;
	if (typeof topicOrOptions === "string") {
		topic = topicOrOptions;
		opts = {};
	} else {
		topic = topicOrOptions.topic;
		opts = { ...topicOrOptions };
		delete opts.topic;
	}
	const func = (raw) => {
		const messagePublishedData = raw.data;
		messagePublishedData.message = new Message(messagePublishedData.message);
		return require_v2_trace.wrapTraceContext(require_common_onInit.withInit(handler))(raw);
	};
	func.run = handler;
	Object.defineProperty(func, "__trigger", { get: () => {
		const baseOpts$1 = require_v2_options.optionsToTriggerAnnotations(require_v2_options.getGlobalOptions());
		const specificOpts$1 = require_v2_options.optionsToTriggerAnnotations(opts);
		return {
			platform: "gcfv2",
			...baseOpts$1,
			...specificOpts$1,
			labels: {
				...baseOpts$1?.labels,
				...specificOpts$1?.labels
			},
			eventTrigger: {
				eventType: "google.cloud.pubsub.topic.v1.messagePublished",
				resource: `projects/${process.env.GCLOUD_PROJECT}/topics/${topic}`
			}
		};
	} });
	const baseOpts = require_v2_options.optionsToEndpoint(require_v2_options.getGlobalOptions());
	const specificOpts = require_v2_options.optionsToEndpoint(opts);
	const endpoint = {
		...require_runtime_manifest.initV2Endpoint(require_v2_options.getGlobalOptions(), opts),
		platform: "gcfv2",
		...baseOpts,
		...specificOpts,
		labels: {
			...baseOpts?.labels,
			...specificOpts?.labels
		},
		eventTrigger: {
			eventType: "google.cloud.pubsub.topic.v1.messagePublished",
			eventFilters: { topic },
			retry: opts.retry ?? false
		}
	};
	require_common_encoding.copyIfPresent(endpoint.eventTrigger, opts, "retry", "retry");
	func.__endpoint = endpoint;
	return func;
}


exports.Message = Message;
exports.onMessagePublished = onMessagePublished;
Object.defineProperty(exports, 'pubsub_exports', {
  enumerable: true,
  get: function () {
    return pubsub_exports;
  }
});
